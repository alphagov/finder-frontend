<% if result_set_presenter.user_supplied_keywords.length > 0 %>
  <% content_for :title, "#{result_set_presenter.user_supplied_keywords} - #{content_item.title}" %>
<% else %>
  <% content_for :title, content_item.title %>
<% end %>

<% content_for :head do %>
  <%= render 'finder_meta', content_item: content_item %>
  <meta name="govuk:search-result-count" content="<%= result_set_presenter.total_count %>">
  <% if result_set_presenter.discovery_engine_attribution_token %>
    <meta name="govuk:discovery-engine-attribution-token" content="<%= result_set_presenter.discovery_engine_attribution_token %>">
  <% end %>
<% end %>
<% content_for :meta_title, content_item.title %>

<form method="get" action="<%= content_item.base_path %>" data-ga4-change-category="clear-all-filters">
  <%= hidden_field_tag :parent, @parent if @parent.present? %>

  <div class="govuk-width-container">
    <%= render 'govuk_publishing_components/components/contextual_breadcrumbs', content_item: content_item.as_hash %>
  </div>

  <div class="govuk-width-container">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <div id="keywords" role="search" aria-label="Sitewide" data-ga4-change-category="update-keyword text">
          <%= render "govuk_publishing_components/components/search_with_autocomplete", {
            id: "finder-keyword-search",
            name: "keywords",
            type: 'search',
            label_text: sanitize("Search <span class='govuk-visually-hidden'>all content on</span> GOV.UK"),
            wrap_label_in_a_heading: true,
            heading_level: 1,
            label_size: "xl",
            value: result_set_presenter.user_supplied_keywords,
            disable_corrections: true,
            source: "https://www.gov.uk/api/search.json?suggest=autocomplete",
            source_key: "suggested_autocomplete"
          } %>
        </div>

        <div class="spelling-suggestions">
          <%= render 'spelling_suggestion' %>
        </div>

        <%= render "govuk_publishing_components/components/skip_link", {
          text: 'Skip to results',
          href: '#search-results',}
        %>

        <%= render "components/filter_panel", {
          button_text: "Filter and sort",
          result_count: result_set_presenter.total_count,
          margin_bottom: 3,
        } do %>
          <%
            sort_options = @sort_presenter.to_hash[:options].reject { |option|
              option[:disabled]
            }.map { |option|
              {
                value: option[:value],
                text: option[:label],
                checked: option[:selected],
              }
            }
          %>
          <%= render 'govuk_publishing_components/components/radio', {
            name: "order",
            id: "order",
            heading: "Sort by",
            heading_level: 3,
            heading_size: "s",
            items: sort_options,
            small: true,
          } %>

          <h3 class="govuk-heading-s">Date</h3>
          <% date_facet = facets.select { _1.key == "public_timestamp" }.first %>
          <div class="govuk-!-margin-bottom-0" id="<%= date_facet.key %>">
            <%= render "govuk_publishing_components/components/input", {
              label: {
                text: date_facet.name + " after"
              },
              name: date_facet.key + "[from]",
              id: date_facet.key + "[from]",
              value: date_facet.user_supplied_from_date,
              hint: "For example, 2005 or 21/11/2014",
              error_message: date_facet.error_message_from(@search_query),
            } %>

            <%= render "govuk_publishing_components/components/input", {
              label: {
                text: date_facet.name + " before"
              },
              name: date_facet.key + "[to]",
              id: date_facet.key + "[to]",
              value: date_facet.user_supplied_to_date,
              hint: "For example, 2005 or 21/11/2014",
              error_message: date_facet.error_message_to(@search_query),
            } %>
          </div>

          <h3 class="govuk-heading-s">Topic</h3>
          <% taxon_facet = facets.select { _1.type == "taxon" }.first %>
          <div class="js-taxonomy-select" data-module="taxonomy-select">
            <%= render "govuk_publishing_components/components/select", {
              id: 'level_one_taxon',
              label: "Topic",
              full_width: true,
              options: taxon_facet.topics
            } %>

            <div class="js-required govuk-form-group">
              <%= render "govuk_publishing_components/components/select", {
                id: 'level_two_taxon',
                label: "Sub-topic",
                full_width: true,
                options: taxon_facet.sub_topics
              } %>
            </div>
          </div>

          <h3 class="govuk-heading-s">Type</h3>
          <% type_facet = facets.select { _1.key == "content_purpose_supergroup" }.first %>
          <% options = type_facet.options(nil, type_facet.key) %>
          <%= render 'govuk_publishing_components/components/checkboxes', {
            name: "#{type_facet.key}[]",
            heading: type_facet.name,
            visually_hide_heading: true,
            no_hint_text: true,
            items: options,
            small: true,
          } %>

          <% hidden_facets = facets.select { _1.type.in?(%w[hidden hidden_clearable]) } %>
          <% hidden_facets.each do |hf| %>
            <%= render hf, facet: hf %>
          <% end %>

          <%= render "govuk_publishing_components/components/button", {
            text: "Apply filters",
            type: "submit",
          } %>
        <% end %>

        <% facet_presenter = facet_tags.present %>
        <% if facet_presenter[:applied_filters].any? || (params[:order].present? && params[:order] != @sort_presenter.default_value) %>
          <div id="search-selected-facets">
            <%= render "govuk_publishing_components/components/heading", {
              text: "Selected filters and sorting",
              heading_level: 2,
              font_size: "s",
              margin_bottom: 2,
            } %>

            <ul class="facet-tag-list">
              <%
                filter_links = facet_presenter[:applied_filters].flat_map { |applied_filter|
                  applied_filter.map { |filter|
                    value = if filter[:data_facet] == "level_one_taxon"
                              "Topic: #{filter[:text]}"
                            elsif filter[:data_facet] == "level_two_taxon"
                              "Sub-topic: #{filter[:text]}"
                            elsif filter[:data_facet] == "content_purpose_supergroup"
                              "Type: #{filter[:text]}"
                            elsif filter[:data_name] == "public_timestamp[from]"
                              "After: #{filter[:text]}"
                            elsif filter[:data_name] == "public_timestamp[to]"
                              "Before: #{filter[:text]}"
                            else
                              filter[:text]
                            end

                    remove_param = if filter[:data_facet] == "level_one_taxon"
                                      %w[level_one_taxon level_two_taxon]
                                  else
                                      [filter[:data_facet]]
                                  end

                    link = url_for(params.to_unsafe_h.except(*remove_param))

                    [value, link]
                  }
                }
              %>
              <% filter_links.each do |text, link| %>
                <li class="facet-tag-list__item">
                  <%= link_to(link, class: "facet-tag-list__link") do %>
                    <span aria-hidden="true" class="facet-tag-list__remove-icon">
                      &#x2715;
                    </span>
                    <span class="govuk-visually-hidden">
                      Remove filter
                    </span>
                    <%= text %>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div id="search-results">
          <% if result_set_presenter.total_count.positive? %>
            <%= render "govuk_publishing_components/components/document_list", {
              disable_ga4: true,
              items: result_set_presenter.search_results_content[:document_list_component_data],
            } %>
          <% else %>
            <div class='no-results govuk-!-font-size-19'>
              <p class='govuk-body govuk-!-font-weight-bold'>There are no matching results.</p>
              <p class='govuk-body'>Improve your search results by:</p>
              <ul class="govuk-list govuk-list--bullet">
                <li>removing filters</li>
                <li>double-checking your spelling</li>
                <li>using fewer keywords</li>
                <li>searching for something less specific</li>
              </ul>
            </div>
          <% end %>
        </div>

        <%= render "govuk_publishing_components/components/previous_and_next_navigation", @pagination.next_and_prev_links %>
      </div>
    </div>
  </div>
</div>
